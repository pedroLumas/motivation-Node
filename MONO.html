<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Actividades con Puntuaci√≥n Diaria</title>
    <!-- Incluye Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Incluye la fuente Manrope de Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Define la fuente Manrope */
        body {
            font-family: 'Manrope', sans-serif;
        }

        /* Estilo para el efecto pulido en m√≥dulos */
        .polished-module {
            background-color: #FFFFFF; /* Blanco */
            background-image:
                /* Gradientes sutiles para el brillo/sombra */
                linear-gradient(to bottom, rgba(0, 0, 0, 0.02) 0%, transparent 10%),
                linear-gradient(to top, rgba(0, 0, 0, 0.02) 0%, transparent 10%);
            background-size: 100% 100%;
            background-blend-mode: overlay;
            /* Sombra interna para dar profundidad y un aspecto pulido */
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05), inset 0 -1px 3px rgba(255, 255, 255, 0.5);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-4">
    <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-5xl flex flex-col lg:flex-row gap-6">
        <!-- Columna Izquierda: Gestionar Actividades (Colapsable) -->
        <div class="flex-1 p-4 border border-gray-200 rounded-xl polished-module text-gray-700">
            <div class="flex justify-between items-center mb-4 cursor-pointer" id="toggleCreateActivityForm">
                <h2 class="text-xl font-bold text-gray-800">Gestionar Actividades</h2>
                <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white text-2xl font-bold transition-transform duration-300 transform">
                    <span id="toggleIcon">+</span>
                </div>
            </div>
            <div id="createActivityFormContent" class="space-y-4 hidden">
                <!-- Formulario para a√±adir nueva actividad reutilizable -->
                <div class="mb-4">
                    <label for="activityName" class="block text-sm font-bold text-gray-700 mb-1">Nombre de la Actividad</label>
                    <input type="text" id="activityName" placeholder="Ej. Tarea de Matem√°ticas"
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm bg-white text-gray-800 font-bold"
                           required>
                </div>
                <div class="mb-4">
                    <label for="activityScore" class="block text-sm font-bold text-gray-700 mb-1">Puntuaci√≥n (-10 a 10)</label>
                    <input type="number" id="activityScore" min="-10" max="10" value="0"
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm bg-white text-gray-800 font-bold"
                           required>
                </div>
                <div class="mb-4">
                    <label for="activityEmoji" class="block text-sm font-bold text-gray-700 mb-1">Emoji (opcional)</label>
                    <input type="text" id="activityEmoji" placeholder="Ej. üìö, üèÉ‚Äç‚ôÇÔ∏è, üò¥" maxlength="2"
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm bg-white text-gray-800 font-bold">
                </div>
                <button id="addActivityBtn"
                        class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-150 ease-in-out shadow-md font-bold">
                    A√±adir Actividad
                </button>
                <button id="suggestActivityLLMBtn"
                        class="w-full mt-4 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-150 ease-in-out shadow-md font-bold flex items-center justify-center">
                    <span id="suggestActivityButtonText">Sugerir Actividad ‚ú®</span>
                    <svg id="suggestActivityLoadingSpinner" class="animate-spin h-5 w-5 text-white ml-2 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Columna Central: Actividades Disponibles (Barra Aislada) -->
        <div class="flex-1 lg:flex-2 p-4 border border-gray-200 rounded-xl polished-module text-gray-700">
            <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">Actividades Disponibles (Haz clic para a√±adir al d√≠a)</h2>
            <div id="availableActivitiesList" class="space-y-3">
                <!-- Las actividades reutilizables se renderizar√°n aqu√≠ -->
            </div>
        </div>

        <!-- Columna Derecha: Resumen Diario -->
        <div class="flex-1 p-4 border border-gray-200 rounded-xl polished-module flex flex-col items-center text-gray-700">
            <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">Resumen Diario</h2>
            <div id="dailySummary" class="flex flex-col items-center space-y-4 w-full">
                <!-- El resumen del d√≠a actual se renderizar√° aqu√≠ -->
                <div class="flex justify-center items-center mb-2 w-full">
                    <h3 class="text-lg font-bold text-gray-800"><span id="todayDate"></span></h3>
                </div>
                <!-- Contenedor de la barra de puntuaci√≥n vertical con dise√±o mejorado (m√°s gorda y redonda) -->
                <div class="w-20 h-80 bg-gray-300 rounded-full flex flex-col relative overflow-hidden shadow-inner mx-auto mt-4">
                    <!-- Barra positiva (verde) con degradado - crece hacia arriba desde el centro -->
                    <div id="positiveBar" class="absolute bottom-1/2 left-0 right-0 bg-gradient-to-t from-green-400 to-green-600 rounded-t-full transition-all duration-300 ease-in-out"
                         style="height: 0%;"></div>
                    <!-- Barra negativa (roja) con degradado - crece hacia abajo desde el centro -->
                    <div id="negativeBar" class="absolute top-1/2 left-0 right-0 bg-gradient-to-b from-red-600 to-red-400 rounded-b-full transition-all duration-300 ease-in-out"
                         style="height: 0%;"></div>
                    <!-- L√≠nea central para claridad visual -->
                    <div class="absolute left-0 right-0 top-1/2 transform -translate-y-1/2 h-0.5 bg-gray-400 z-10"></div>
                </div>
            </div>

            <!-- Nuevo apartado de Estad√≠sticas Diarias (Colapsable por Emojis) -->
            <div class="w-full mt-6 p-4 border border-gray-200 rounded-xl bg-gray-100 text-gray-700">
                <div class="flex justify-between items-center mb-4 cursor-pointer" id="toggleStatistics">
                    <h2 class="text-xl font-bold text-gray-800">üìäüìâüìà</h2>
                    <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white text-2xl font-bold transition-transform duration-300 transform">
                        <span id="statisticsToggleIcon">+</span>
                    </div>
                </div>
                <div id="statisticsContent" class="space-y-4 hidden">
                    <!-- Panel atractivo para las estad√≠sticas -->
                    <div id="statisticsDisplayPanel" class="bg-white p-6 rounded-lg shadow-xl border border-gray-200">
                        <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">Estad√≠sticas Detalladas</h3>
                        <div class="mb-4">
                            <p class="font-bold text-lg text-gray-700">Total Positivo: <span id="totalPositiveScore" class="text-green-600">0</span></p>
                            <p class="font-bold text-lg text-gray-700">Total Negativo: <span id="totalNegativeScore" class="text-red-600">0</span></p>
                        </div>
                        <div class="mb-4">
                            <p class="font-bold text-gray-700">Actividades Positivas: <span id="countPositiveActivities">0</span></p>
                            <p class="font-bold text-gray-700">Actividades Negativas: <span id="countNegativeActivities">0</span></p>
                            <p class="font-bold text-gray-700">Actividades Neutrales: <span id="countNeutralActivities">0</span></p>
                        </div>
                        <!-- Tres barras peque√±as para representar el conteo de actividades -->
                        <div class="flex flex-col items-start space-y-2 mt-4">
                            <div class="flex items-center w-full">
                                <span class="text-green-600 font-bold mr-2">Positivas:</span>
                                <div class="h-4 bg-gray-300 rounded-full flex-grow overflow-hidden shadow-inner">
                                    <div id="barPositiveCount" class="h-full bg-gradient-to-r from-green-400 to-green-600 rounded-full" style="width: 0%;"></div>
                                </div>
                            </div>
                            <div class="flex items-center w-full">
                                <span class="text-red-600 font-bold mr-2">Negativas:</span>
                                <div class="h-4 bg-gray-300 rounded-full flex-grow overflow-hidden shadow-inner">
                                    <div id="barNegativeCount" class="h-full bg-gradient-to-r from-red-600 to-red-400 rounded-full" style="width: 0%;"></div>
                                </div>
                            </div>
                            <div class="flex items-center w-full">
                                <span class="text-blue-600 font-bold mr-2">Neutrales:</span>
                                <div class="h-4 bg-gray-300 rounded-full flex-grow overflow-hidden shadow-inner">
                                    <div id="barNeutralCount" class="h-full bg-gradient-to-r from-blue-400 to-blue-600 rounded-full" style="width: 0%;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

             <button id="suggestImprovementsBtn"
                    class="w-full mt-4 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-150 ease-in-out shadow-md font-bold flex items-center justify-center">
                <span id="suggestImprovementsButtonText">Sugerir Mejoras para Ma√±ana ‚ú®</span>
                <svg id="suggestImprovementsLoadingSpinner" class="animate-spin h-5 w-5 text-white ml-2 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </button>
            <div id="dailyImprovementsOutput" class="mt-4 p-3 bg-blue-200 rounded-lg shadow-sm border border-blue-300 text-gray-700 text-sm hidden w-full font-bold">
                <h4 class="text-lg font-bold mb-2">Sugerencias para Ma√±ana:</h4>
                <ul id="improvementsList" class="list-disc pl-5 space-y-1"></ul>
            </div>
        </div>

        <!-- Mensaje de error/informaci√≥n (fuera de las columnas para mejor visibilidad) -->
        <div id="messageBox" class="hidden px-4 py-3 rounded-md relative mb-4 fixed bottom-4 right-4 z-50 shadow-lg">
            <span id="messageText" class="block sm:inline font-bold"></span>
            <span class="absolute top-0 bottom-0 right-0 px-4 py-3 cursor-pointer" onclick="document.getElementById('messageBox').classList.add('hidden');">
                <svg class="fill-current h-6 w-6" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Cerrar</title><path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.152a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.152 2.758 3.15a1.2 1.2 0 0 1 0 1.698z"/></svg>
            </span>
        </div>

    </div>

    <!-- Modal para las tareas del d√≠a -->
    <div id="dailyTasksModal" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50 hidden modal-overlay">
        <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-md modal-content overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-gray-800">Tareas de Hoy (<span id="modalTodayDate"></span>)</h3>
                <button id="closeDailyTasksModal" class="text-gray-400 hover:text-gray-700 text-3xl font-bold">&times;</button>
            </div>

            <!-- Barra de progreso horizontal para el total del d√≠a en el modal -->
            <div class="w-full h-6 bg-gray-300 rounded-full flex relative overflow-hidden shadow-inner mb-4">
                <div id="modalPositiveBar" class="absolute h-full bg-gradient-to-r from-green-400 to-green-600 rounded-r-full transition-all duration-300 ease-in-out"
                     style="left: 50%; width: 0%;"></div>
                <div id="modalNegativeBar" class="absolute h-full bg-gradient-to-l from-red-600 to-red-400 rounded-l-full transition-all duration-300 ease-in-out"
                     style="left: 50%; width: 0%;"></div>
                <div class="absolute left-1/2 transform -translate-x-1/2 h-full w-0.5 bg-gray-400 z-10"></div>
            </div>
            <p class="text-center text-gray-800 text-lg font-bold mb-4">Total: <span id="modalDailyScore">0</span></p>

            <div id="dailyTasksListInModal" class="space-y-3">
                <!-- Las tareas del d√≠a se listar√°n aqu√≠ -->
            </div>
             <p id="noTasksMessage" class="text-center text-gray-500 font-bold mt-4 hidden">No hay tareas a√±adidas para hoy.</p>
        </div>
    </div>


    <script>
        // Array para almacenar las actividades reutilizables (plantillas)
        let reusableActivities = [];
        // Objeto para almacenar las puntuaciones acumuladas por d√≠a
        // Formato: { 'YYYY-MM-DD': totalScore } - Esto es ahora el total calculado
        let dailyScores = {};
        // Objeto para almacenar las actividades reales a√±adidas cada d√≠a
        // Formato: { 'YYYY-MM-DD': [{ name: 'Task', score: 5, emoji: 'üìö' }, ...] }
        let dailyActivities = {};


        // Obtener la fecha actual en formato YYYY-MM-DD
        const today = new Date().toISOString().slice(0, 10);

        // Referencias a los elementos del DOM
        const activityNameInput = document.getElementById('activityName');
        const activityScoreInput = document.getElementById('activityScore');
        const activityEmojiInput = document.getElementById('activityEmoji');
        const addActivityBtn = document.getElementById('addActivityBtn');
        const availableActivitiesListDiv = document.getElementById('availableActivitiesList');
        const dailySummaryDiv = document.getElementById('dailySummary');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');

        // Referencias para la sugerencia de actividad LLM
        const suggestActivityLLMBtn = document.getElementById('suggestActivityLLMBtn');
        const suggestActivityButtonText = document.getElementById('suggestActivityButtonText');
        const suggestActivityLoadingSpinner = document.getElementById('suggestActivityLoadingSpinner');

        // Referencias para la sugerencia de mejoras LLM
        const suggestImprovementsBtn = document.getElementById('suggestImprovementsBtn');
        const suggestImprovementsButtonText = document.getElementById('suggestImprovementsButtonText');
        const suggestImprovementsLoadingSpinner = document.getElementById('suggestImprovementsLoadingSpinner');
        const dailyImprovementsOutput = document.getElementById('dailyImprovementsOutput');
        const improvementsList = document.getElementById('improvementsList');


        // Referencias para la funcionalidad colapsable de Gestionar Actividades
        const toggleCreateActivityForm = document.getElementById('toggleCreateActivityForm');
        const createActivityFormContent = document.getElementById('createActivityFormContent');
        const toggleIcon = document.getElementById('toggleIcon');

        // Nuevas referencias para el apartado de Estad√≠sticas Diarias
        const toggleStatistics = document.getElementById('toggleStatistics'); // Ahora se usa para el click en los emojis
        const statisticsContent = document.getElementById('statisticsContent');
        const statisticsDisplayPanel = document.getElementById('statisticsDisplayPanel');
        const statisticsToggleIcon = document.getElementById('statisticsToggleIcon'); // El icono sigue siendo el de alternancia
        const totalPositiveScore = document.getElementById('totalPositiveScore');
        const totalNegativeScore = document.getElementById('totalNegativeScore');
        const countPositiveActivities = document.getElementById('countPositiveActivities');
        const countNegativeActivities = document.getElementById('countNegativeActivities');
        const countNeutralActivities = document.getElementById('countNeutralActivities');
        // Nuevas referencias para las barras de conteo de estad√≠sticas
        const barPositiveCount = document.getElementById('barPositiveCount');
        const barNegativeCount = document.getElementById('barNegativeCount');
        const barNeutralCount = document.getElementById('barNeutralCount');


        // Referencias para el modal de tareas del d√≠a
        const dailyTasksModal = document.getElementById('dailyTasksModal');
        const closeDailyTasksModal = document.getElementById('closeDailyTasksModal');
        const dailyTasksListInModal = document.getElementById('dailyTasksListInModal');
        const modalTodayDate = document.getElementById('modalTodayDate');
        const modalDailyScore = document.getElementById('modalDailyScore');
        const modalPositiveBar = document.getElementById('modalPositiveBar');
        const modalNegativeBar = document.getElementById('modalNegativeBar');
        const noTasksMessage = document.getElementById('noTasksMessage');

        // Elementos de la barra vertical principal
        const todayDateDisplay = document.getElementById('todayDate');
        const positiveBar = document.getElementById('positiveBar');
        const negativeBar = document.getElementById('negativeBar');


        /**
         * Mapeo de d√≠gitos a emojis num√©ricos.
         */
        const emojiNumbers = {
            '0': '0Ô∏è‚É£', '1': '1Ô∏è‚É£', '2': '2Ô∏è‚É£', '3': '3Ô∏è‚É£', '4': '4Ô∏è‚É£',
            '5': '5Ô∏è‚É£', '6': '6Ô∏è‚É£', '7': '7Ô∏è‚É£', '8': '8Ô∏è‚É£', '9': '9Ô∏è‚É£'
        };

        /**
         * Convierte una cadena de fecha YYYY-MM-DD a formato DD/MM/YYYY con emojis.
         * @param {string} dateString - La fecha en formato YYYY-MM-DD.
         * @returns {string} La fecha en formato DD/MM/YYYY con emojis.
         */
        function formatEmojiDate(dateString) {
            const [year, month, day] = dateString.split('-');
            const dayEmoji = day.split('').map(char => emojiNumbers[char] || char).join('');
            const monthEmoji = month.split('').map(char => emojiNumbers[char] || char).join('');
            const yearEmoji = year.split('').map(char => emojiNumbers[char] || char).join('');

            return `${dayEmoji}/${monthEmoji}/${yearEmoji}`;
        }

        /**
         * Guarda los datos actuales en localStorage.
         */
        function saveData() {
            localStorage.setItem('reusableActivities', JSON.stringify(reusableActivities));
            localStorage.setItem('dailyActivities', JSON.stringify(dailyActivities)); // Guardar las actividades diarias
        }

        /**
         * Carga los datos desde localStorage.
         */
        function loadData() {
            const storedActivities = localStorage.getItem('reusableActivities');
            if (storedActivities) {
                reusableActivities = JSON.parse(storedActivities);
            }

            const storedDailyActivities = localStorage.getItem('dailyActivities');
            if (storedDailyActivities) {
                dailyActivities = JSON.parse(storedDailyActivities);
            }

            // Asegurarse de que la lista de actividades del d√≠a actual est√© inicializada
            if (!dailyActivities[today]) {
                dailyActivities[today] = [];
            }
            // Calcular el dailyScores[today] a partir de dailyActivities[today]
            dailyScores[today] = dailyActivities[today].reduce((sum, activity) => sum + activity.score, 0);
        }

        /**
         * Muestra un mensaje en la caja de mensajes con colores din√°micos.
         * @param {string} message - El mensaje a mostrar.
         * @param {number} score - La puntuaci√≥n de la actividad que determina el color.
         */
        function showMessage(message, score) {
            messageText.textContent = message;
            messageBox.classList.remove('hidden', 'bg-red-100', 'border-red-400', 'text-red-700', 'bg-green-100', 'border-green-400', 'text-green-700', 'bg-blue-100', 'border-blue-400', 'text-blue-700');
            messageBox.querySelector('svg').classList.remove('text-red-500', 'text-green-500', 'text-blue-500');

            if (score > 0) {
                messageBox.classList.add('bg-green-100', 'border-green-400', 'text-green-700');
                messageBox.querySelector('svg').classList.add('text-green-500');
            } else if (score < 0) {
                messageBox.classList.add('bg-red-100', 'border-red-400', 'text-red-700');
                messageBox.querySelector('svg').classList.add('text-red-500');
            } else { // score === 0
                messageBox.classList.add('bg-blue-100', 'border-blue-400', 'text-blue-700');
                messageBox.querySelector('svg').classList.add('text-blue-500');
            }

            // Ocultar el mensaje despu√©s de 3 segundos
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 3000);
        }

        /**
         * Obtiene un emoji por defecto basado en la puntuaci√≥n.
         * @param {number} score - La puntuaci√≥n de la actividad.
         * @returns {string} El emoji por defecto.
         */
        function getDefaultEmoji(score) {
            if (score > 0) {
                return '‚úÖ'; // Positivo
            } else if (score < 0) {
                return '‚ùå'; // Negativo
            } else {
                return 'üí°'; // Neutral
            }
        }

        /**
         * Renderiza la lista de actividades reutilizables en el DOM.
         */
        function renderAvailableActivities() {
            availableActivitiesListDiv.innerHTML = ''; // Limpiar la lista actual

            if (reusableActivities.length === 0) {
                availableActivitiesListDiv.innerHTML = '<p class="text-center font-bold text-gray-700">No hay actividades reutilizables. ¬°Crea una!</p>';
                return;
            }

            reusableActivities.forEach((activity, index) => {
                const activityItem = document.createElement('div');
                // Usar bg-blue-200 para los elementos de la lista para un contraste sutil con el fondo del m√≥dulo
                activityItem.className = 'flex justify-between items-center p-3 bg-blue-200 rounded-md shadow-sm border border-blue-300 cursor-pointer hover:bg-blue-300 transition duration-150 ease-in-out';
                activityItem.dataset.index = index; // Guardar el √≠ndice para acceder a la actividad
                activityItem.innerHTML = `
                    <span class="text-md font-bold text-gray-800">${activity.emoji || getDefaultEmoji(activity.score)} ${activity.name}</span>
                    <span class="text-lg font-bold ${activity.score >= 0 ? 'text-green-600' : 'text-red-600'}">${activity.score}</span>
                    <button class="delete-activity-btn text-red-500 hover:text-red-700 ml-2 text-xl" data-index="${index}">üóëÔ∏è</button>
                `;
                availableActivitiesListDiv.appendChild(activityItem);
            });
        }

        /**
         * Renderiza el resumen de puntuaci√≥n para el d√≠a actual.
         */
        function renderDailySummary() {
            const currentDayScore = dailyScores[today] || 0; // Obtener la puntuaci√≥n del d√≠a actual, o 0 si no existe

            todayDateDisplay.textContent = formatEmojiDate(today); // Formatear la fecha con emojis

            // Calcular el porcentaje de la barra vertical. El rango total es de -100 a 100.
            let positiveHeight = 0;
            let negativeHeight = 0;

            if (currentDayScore > 0) {
                positiveHeight = (currentDayScore / 100) * 50; // Max 50% for positive, scaled to 100 max score
            } else if (currentDayScore < 0) {
                negativeHeight = (Math.abs(currentDayScore) / 100) * 50; // Max 50% for negative, scaled to 100 max score
            }

            positiveBar.style.height = `${positiveHeight}%`;
            negativeBar.style.height = `${negativeHeight}%`;

            // Tambi√©n actualizamos las estad√≠sticas en el nuevo m√≥dulo
            renderStatistics();
        }

        /**
         * Renderiza la lista de tareas del d√≠a en el modal.
         */
        function renderDailyTaskListModal() {
            dailyTasksListInModal.innerHTML = ''; // Limpiar la lista actual
            const tasks = dailyActivities[today] || [];
            let modalCurrentDayScore = 0;

            modalTodayDate.textContent = formatEmojiDate(today); // Formatear la fecha con emojis en el modal

            if (tasks.length === 0) {
                noTasksMessage.classList.remove('hidden');
            } else {
                noTasksMessage.classList.add('hidden');
                tasks.forEach((task) => {
                    const taskItem = document.createElement('div');
                    taskItem.className = 'flex justify-between items-center p-3 bg-gray-100 rounded-md shadow-sm border border-gray-200 text-gray-800';
                    taskItem.innerHTML = `
                        <span class="text-md font-bold">${task.emoji || getDefaultEmoji(task.score)} ${task.name}</span>
                        <span class="text-lg font-bold ${task.score >= 0 ? 'text-green-600' : 'text-red-600'}">${task.score}</span>
                    `;
                    dailyTasksListInModal.appendChild(taskItem);
                    modalCurrentDayScore += task.score;
                });
            }

            modalDailyScore.textContent = modalCurrentDayScore;
            modalDailyScore.classList.toggle('text-green-600', modalCurrentDayScore >= 0);
            modalDailyScore.classList.toggle('text-red-600', modalCurrentDayScore < 0);

            // Actualizar la barra horizontal del modal
            let modalPositiveWidth = 0;
            let modalNegativeWidth = 0;
            let modalNegativeLeft = 50;

            if (modalCurrentDayScore > 0) {
                modalPositiveWidth = (modalCurrentDayScore / 100) * 50;
            } else if (modalCurrentDayScore < 0) {
                modalNegativeWidth = (Math.abs(modalCurrentDayScore) / 100) * 50;
                modalNegativeLeft = 50 - modalNegativeWidth;
            }

            modalPositiveBar.style.width = `${modalPositiveWidth}%`;
            modalNegativeBar.style.width = `${modalNegativeWidth}%`;
            modalNegativeBar.style.left = `${modalNegativeLeft}%`;
            modalPositiveBar.style.left = `50%`; // Asegurar que la barra positiva siempre empieza en el centro
        }

        /**
         * Calcula y renderiza las estad√≠sticas diarias.
         */
        function renderStatistics() {
            const tasks = dailyActivities[today] || [];
            let posScore = 0;
            let negScore = 0;
            let posCount = 0;
            let negCount = 0;
            let neutralCount = 0;

            tasks.forEach(task => {
                if (task.score > 0) {
                    posScore += task.score;
                    posCount++;
                } else if (task.score < 0) {
                    negScore += task.score;
                    negCount++;
                } else {
                    neutralCount++;
                }
            });

            totalPositiveScore.textContent = posScore;
            totalNegativeScore.textContent = negScore;
            countPositiveActivities.textContent = posCount;
            countNegativeActivities.textContent = negCount;
            countNeutralActivities.textContent = neutralCount;

            // Actualizar las tres barras de conteo de actividades
            const maxCount = Math.max(posCount, negCount, neutralCount, 1); // Asegurar que no dividimos por cero
            barPositiveCount.style.width = `${(posCount / maxCount) * 100}%`;
            barNegativeCount.style.width = `${(negCount / maxCount) * 100}%`;
            barNeutralCount.style.width = `${(neutralCount / maxCount) * 100}%`;
        }


        /**
         * Maneja el evento de a√±adir una nueva actividad reutilizable.
         */
        addActivityBtn.addEventListener('click', () => {
            const name = activityNameInput.value.trim();
            const score = parseInt(activityScoreInput.value);
            const emoji = activityEmojiInput.value.trim(); // Obtener el emoji del input

            if (!name) {
                showMessage('Por favor, introduce un nombre para la actividad.', 0); // Neutral color for input error
                return;
            }

            if (isNaN(score) || score < -10 || score > 10) {
                showMessage('La puntuaci√≥n debe ser un n√∫mero entero entre -10 y 10.', 0); // Neutral color for input error
                return;
            }

            reusableActivities.push({ name, score, emoji }); // Guardar el emoji
            activityNameInput.value = ''; // Limpiar el campo de nombre
            activityScoreInput.value = '0'; // Resetear la puntuaci√≥n
            activityEmojiInput.value = ''; // Limpiar el campo de emoji
            saveData(); // Guardar los datos
            renderAvailableActivities(); // Volver a renderizar la lista de actividades disponibles
        });

        /**
         * Maneja el clic en una actividad disponible para a√±adirla al d√≠a actual.
         */
        availableActivitiesListDiv.addEventListener('click', (event) => {
            // Comprobar si el clic fue en el bot√≥n de eliminar
            if (event.target.classList.contains('delete-activity-btn')) {
                const indexToDelete = parseInt(event.target.dataset.index);
                reusableActivities.splice(indexToDelete, 1); // Eliminar la actividad del array
                saveData(); // Guardar los cambios
                renderAvailableActivities(); // Re-renderizar la lista
                return; // Salir de la funci√≥n para no a√±adir la actividad
            }

            const clickedItem = event.target.closest('div[data-index]');
            if (clickedItem) {
                const index = parseInt(clickedItem.dataset.index);
                const activity = reusableActivities[index];

                if (activity) {
                    // A√±adir la actividad a la lista de actividades del d√≠a
                    if (!dailyActivities[today]) {
                        dailyActivities[today] = [];
                    }
                    dailyActivities[today].push(activity);

                    // Recalcular la puntuaci√≥n total del d√≠a
                    dailyScores[today] = dailyActivities[today].reduce((sum, act) => sum + act.score, 0);
                    // Asegurarse de que el score no exceda los l√≠mites de -100 a 100
                    dailyScores[today] = Math.max(-100, Math.min(100, dailyScores[today]));

                    saveData(); // Guardar los datos
                    renderDailySummary(); // Actualizar el resumen del d√≠a principal
                    dailyImprovementsOutput.classList.add('hidden'); // Ocultar sugerencias anteriores
                }
            }
        });

        /**
         * Genera una sugerencia de actividad usando la API de Gemini para rellenar el formulario.
         */
        suggestActivityLLMBtn.addEventListener('click', async () => {
            // Mostrar spinner y deshabilitar bot√≥n
            suggestActivityButtonText.textContent = 'Sugiriendo...';
            suggestActivityLoadingSpinner.classList.remove('hidden');
            suggestActivityLLMBtn.disabled = true;

            try {
                let chatHistory = [];
                const prompt = `Sugiere una actividad diaria con un nombre, una puntuaci√≥n entre -10 y 10, y un emoji representativo. La actividad debe ser algo com√∫n que la gente haga. Responde en formato JSON con las claves 'name' (string), 'score' (integer) y 'emoji' (string, opcional, m√°ximo 2 caracteres). Por ejemplo: {'name': 'Leer un libro', 'score': 5, 'emoji': 'üìö'}`;

                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = {
                    contents: chatHistory,
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "name": { "type": "STRING" },
                                "score": { "type": "NUMBER", "minimum": -10, "maximum": 10 },
                                "emoji": { "type": "STRING", "maxLength": 2, "description": "Optional emoji for the activity" }
                            },
                            "required": ["name", "score"]
                        }
                    }
                };
                const apiKey = ""; // La clave API ser√° proporcionada por el entorno de Canvas
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const suggestedActivity = JSON.parse(result.candidates[0].content.parts[0].text);
                    activityNameInput.value = suggestedActivity.name;
                    activityScoreInput.value = suggestedActivity.score;
                    activityEmojiInput.value = suggestedActivity.emoji || ''; // Rellenar el emoji si existe
                } else {
                    showMessage('No se pudo generar una sugerencia de actividad. Int√©ntalo de nuevo.', 0);
                }
            } catch (error) {
                console.error('Error al generar la sugerencia de actividad:', error);
                showMessage('Error al conectar con el servicio de sugerencias. Por favor, int√©ntalo m√°s tarde.', 0);
            } finally {
                // Ocultar spinner y habilitar bot√≥n
                suggestActivityButtonText.textContent = 'Sugerir Actividad ‚ú®';
                suggestActivityLoadingSpinner.classList.add('hidden');
                suggestActivityLLMBtn.disabled = false;
            }
        });

        /**
         * Genera sugerencias de mejora para el d√≠a siguiente usando la API de Gemini.
         */
        suggestImprovementsBtn.addEventListener('click', async () => {
            const currentDayScore = dailyScores[today] || 0;
            const activitiesToday = dailyActivities[today] || [];

            // Mostrar spinner y deshabilitar bot√≥n
            suggestImprovementsButtonText.textContent = 'Sugiriendo Mejoras...';
            suggestImprovementsLoadingSpinner.classList.remove('hidden');
            suggestImprovementsBtn.disabled = true;
            dailyImprovementsOutput.classList.add('hidden'); // Ocultar salida anterior

            try {
                let chatHistory = [];
                const prompt = `Eres un asistente de planificaci√≥n de actividades. Bas√°ndote en la puntuaci√≥n total de actividades de hoy, que es ${currentDayScore}, y las actividades realizadas hoy: ${JSON.stringify(activitiesToday)}.
                Sugiere 3-5 actividades espec√≠ficas para ma√±ana que podr√≠an ayudar a mejorar tu balance general o a abordar √°reas d√©biles.
                Para cada sugerencia, incluye un 'name' (string), una 'score' (integer entre -10 y 10), y un 'emoji' (string, opcional, m√°ximo 2 caracteres).
                Responde en formato JSON como un array de objetos. Por ejemplo:
                [
                  {"name": "Hacer ejercicio ligero", "score": 7, "emoji": "üèãÔ∏è"},
                  {"name": "Aprender algo nuevo", "score": 8, "emoji": "üß†"}
                ]`;

                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = {
                    contents: chatHistory,
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "ARRAY",
                            items: {
                                type: "OBJECT",
                                properties: {
                                    "name": { "type": "STRING" },
                                    "score": { "type": "NUMBER", "minimum": -10, "maximum": 10 },
                                    "emoji": { "type": "STRING", "maxLength": 2, "description": "Optional emoji for the activity" }
                                },
                                "required": ["name", "score"]
                            }
                        }
                    }
                };
                const apiKey = ""; // La clave API ser√° proporcionada por el entorno de Canvas
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const suggestedImprovements = JSON.parse(result.candidates[0].content.parts[0].text);
                    improvementsList.innerHTML = ''; // Limpiar lista anterior
                    if (suggestedImprovements.length > 0) {
                        suggestedImprovements.forEach(suggestion => {
                            const listItem = document.createElement('li');
                            listItem.className = `text-gray-700 font-bold`; // Adjusted text color for light background
                            listItem.innerHTML = `${suggestion.emoji || getDefaultEmoji(suggestion.score)} ${suggestion.name} (${suggestion.score})`;
                            improvementsList.appendChild(listItem);
                        });
                        dailyImprovementsOutput.classList.remove('hidden');
                    } else {
                        dailyImprovementsOutput.textContent = 'No se pudieron generar sugerencias de mejora.';
                        dailyImprovementsOutput.classList.remove('hidden');
                    }
                } else {
                    dailyImprovementsOutput.textContent = 'No se pudieron generar sugerencias de mejora. Int√©ntalo de nuevo.';
                    dailyImprovementsOutput.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error al generar sugerencias de mejora:', error);
                dailyImprovementsOutput.textContent = 'Error al conectar con el servicio de sugerencias de mejora. Por favor, int√©ntalo m√°s tarde.';
                dailyImprovementsOutput.classList.remove('hidden');
            } finally {
                // Ocultar spinner y habilitar bot√≥n
                suggestImprovementsButtonText.textContent = 'Sugerir Mejoras para Ma√±ana ‚ú®';
                suggestImprovementsLoadingSpinner.classList.add('hidden');
                suggestImprovementsBtn.disabled = false;
            }
        });

        // Funcionalidad para colapsar/expandir el formulario de crear actividad
        toggleCreateActivityForm.addEventListener('click', () => {
            createActivityFormContent.classList.toggle('hidden');
            if (createActivityFormContent.classList.contains('hidden')) {
                toggleIcon.textContent = '+';
            } else {
                toggleIcon.textContent = '-';
            }
        });

        // Funcionalidad para colapsar/expandir el apartado de Estad√≠sticas Diarias
        toggleStatistics.addEventListener('click', () => {
            statisticsContent.classList.toggle('hidden');
            if (statisticsContent.classList.contains('hidden')) {
                statisticsToggleIcon.textContent = '+';
            } else {
                statisticsToggleIcon.textContent = '-';
                renderStatistics(); // Renderizar estad√≠sticas cada vez que se abre
            }
        });


        // Event listeners para el modal de tareas del d√≠a
        // showDailyTasksBtn.addEventListener('click', () => { // Eliminado el event listener
        //     renderDailyTaskListModal(); // Renderizar antes de mostrar
        //     dailyTasksModal.classList.remove('hidden');
        // });

        closeDailyTasksModal.addEventListener('click', () => {
            dailyTasksModal.classList.add('hidden');
        });

        // Cerrar modal al hacer clic fuera de √©l
        dailyTasksModal.addEventListener('click', (event) => {
            if (event.target === dailyTasksModal) {
                dailyTasksModal.classList.add('hidden');
            }
        });


        // Renderizar las actividades disponibles y el resumen diario al cargar la p√°gina por primera vez
        document.addEventListener('DOMContentLoaded', () => {
            loadData(); // Cargar datos al inicio
            renderAvailableActivities();
            renderDailySummary();
            // Asegurarse de que el contenido de estad√≠sticas est√© oculto por defecto
            statisticsContent.classList.add('hidden');
            statisticsToggleIcon.textContent = '+'; // Asegurarse de que el icono sea '+' al inicio
        });
    </script>
</body>
</html>
